// =============================================================================
// logger.h - 日志系统头文件
// =============================================================================
//
// 功能: 提供双输出日志功能 (终端 + 文件)
//
// 特性:
//   - 自动时间戳 (精确到毫秒)
//   - 同时输出到控制台和日志文件
//   - RAII 机制自动管理生命周期
//   - 支持中文标签分类
//
// 使用方式:
//   Logger logger("output/log");  // 创建日志对象
//   Log("[初始化] 程序启动");     // 使用 Log 宏输出
//
// =============================================================================

#ifndef LOGGER_H
#define LOGGER_H

#include <iostream>
#include <fstream>
#include <sstream>
#include <string>
#include <memory>
#include <chrono>
#include <iomanip>
#include <ctime>

// =============================================================================
// DualStreambuf - 双输出流缓冲区
// =============================================================================
// 功能: 将输出同时发送到控制台和文件
// =============================================================================
class DualStreambuf : public std::streambuf {
public:
    // -------------------------------------------------------------------------
    // 构造函数
    // -------------------------------------------------------------------------
    DualStreambuf(std::streambuf* console_buf, std::streambuf* file_buf);

    // -------------------------------------------------------------------------
    // 禁用复制和移动
    // -------------------------------------------------------------------------
    DualStreambuf(const DualStreambuf&) = delete;
    DualStreambuf& operator=(const DualStreambuf&) = delete;
    DualStreambuf(DualStreambuf&&) = delete;
    DualStreambuf& operator=(DualStreambuf&&) = delete;

protected:
    // -------------------------------------------------------------------------
    // 重写流缓冲区虚函数
    // -------------------------------------------------------------------------
    int overflow(int c) override;
    std::streamsize xsputn(const char* s, std::streamsize count) override;

private:
    std::streambuf* console_buf_;   // 控制台缓冲区
    std::streambuf* file_buf_;      // 文件缓冲区
    bool need_timestamp_;           // 是否需要输出时间戳

    // -------------------------------------------------------------------------
    // 内部辅助函数
    // -------------------------------------------------------------------------
    std::string getCurrentTimestamp();
    void writeTimestamp();
};

// =============================================================================
// Logger - 日志管理器
// =============================================================================
// 功能: 管理日志文件的创建和输出重定向
// =============================================================================
class Logger {
public:
    // -------------------------------------------------------------------------
    // 构造函数 - 初始化日志系统
    // -------------------------------------------------------------------------
    // 参数: log_prefix - 日志文件前缀 (自动添加 .log 扩展名)
    // -------------------------------------------------------------------------
    explicit Logger(const std::string& log_prefix);

    // -------------------------------------------------------------------------
    // 析构函数 - 恢复标准输出并关闭日志文件
    // -------------------------------------------------------------------------
    ~Logger();

    // -------------------------------------------------------------------------
    // 禁用复制和移动
    // -------------------------------------------------------------------------
    Logger(const Logger&) = delete;
    Logger& operator=(const Logger&) = delete;
    Logger(Logger&&) = delete;
    Logger& operator=(Logger&&) = delete;

    // -------------------------------------------------------------------------
    // 获取日志文件路径
    // -------------------------------------------------------------------------
    std::string getLogFilePath() const { return log_file_path_; }

private:
    std::ofstream log_file_;                    // 日志文件流
    std::streambuf* old_cout_buf_;              // 原始 cout 缓冲区
    std::unique_ptr<DualStreambuf> dual_buf_;   // 双输出缓冲区
    std::string log_file_path_;                 // 日志文件路径
};

// =============================================================================
// 辅助函数
// =============================================================================

// -----------------------------------------------------------------------------
// GetCurrentTimestamp - 获取当前时间戳字符串
// -----------------------------------------------------------------------------
// 返回格式: YYYYMMDD_HHMMSS_mmm
// 用途: 生成日志文件名
// -----------------------------------------------------------------------------
inline std::string GetCurrentTimestamp() {
    auto now = std::chrono::system_clock::now();
    auto time_t = std::chrono::system_clock::to_time_t(now);
    auto ms = std::chrono::duration_cast<std::chrono::milliseconds>(
        now.time_since_epoch()) % 1000;

    std::stringstream ss;
    ss << std::put_time(std::localtime(&time_t), "%Y%m%d_%H%M%S")
       << "_" << std::setfill('0') << std::setw(3) << ms.count();
    return ss.str();
}

// =============================================================================
// 日志输出宏
// =============================================================================

// Log - 带换行的日志输出
#define Log(msg) std::cout << msg << std::endl

// LogNoNL - 不带换行的日志输出
#define LogNoNL(msg) std::cout << msg

// LogFmt - 格式化日志输出 (支持 printf 风格)
#define LogFmt(fmt, ...) do { \
    char _log_buf[1024]; \
    snprintf(_log_buf, sizeof(_log_buf), fmt, ##__VA_ARGS__); \
    std::cout << _log_buf; \
} while(0)

#endif // LOGGER_H
