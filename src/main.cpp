// =============================================================================
// main.cpp - 程序入口
// =============================================================================
//
// 功能: 二维下料问题分支定价求解器的主函数
//
// 算法流程:
//   1. 读取数据
//   2. 原始启发式生成初始解
//   3. 根节点列生成求解
//   4. 检查整数性, 若需要则进入分支定界
//   5. 输出结果
//
// =============================================================================

#include "2DBP.h"
#include <filesystem>

using namespace std;

int main() {
	// =========================================================================
	// 初始化日志系统
	// =========================================================================
	string log_file = "log_2DBP_" + GetCurrentTimestamp();
	Logger logger(log_file);

	cout << "[调试] 日志系统初始化成功\n";
	cout << "[调试] 日志文件: " << logger.getLogFilePath() << "\n";

	// 记录程序开始时间
	auto start_time = chrono::high_resolution_clock::now();

	cout << "\n";
	cout << "============================================================\n";
	cout << "  二维下料问题分支定价求解器 (CS-2D-BP)\n";
	cout << "============================================================\n";
	cout << "\n";

	// 初始化全局数据容器
	All_Lists Lists;
	All_Values Values;

	// 初始化根节点
	Node root_node;
	root_node.index = 1;
	Values.branch_status = 0;

	// =========================================================================
	// 阶段1: 数据读取与预处理
	// =========================================================================
	cout << "[阶段1] 数据读取与预处理\n";
	cout << "------------------------------------------------------------\n";
	ReadData(Values, Lists);
	cout << "\n";

	// =========================================================================
	// 阶段2: 原始启发式生成初始解
	// =========================================================================
	cout << "[阶段2] 原始启发式生成初始解\n";
	cout << "------------------------------------------------------------\n";
	PrimalHeuristic(Values, Lists, root_node);
	cout << "\n";

	// =========================================================================
	// 阶段3: 根节点列生成求解
	// =========================================================================
	cout << "[阶段3] 根节点列生成求解\n";
	cout << "------------------------------------------------------------\n";
	RootNodeColumnGeneration(Values, Lists, root_node);
	cout << "\n";

	// =========================================================================
	// 阶段4: 检查整数性并决定是否分支
	// =========================================================================
	cout << "[阶段4] 整数性检查\n";
	cout << "------------------------------------------------------------\n";
	Values.search_flag = FinishNode(Values, Lists, root_node);

	// 将根节点加入节点列表
	Lists.all_nodes_list.push_back(root_node);
	Values.root_flag = 1;
	cout << "\n";

	// =========================================================================
	// 阶段5: 分支定界 (若需要)
	// =========================================================================
	if (Values.search_flag == 0) {
		cout << "[阶段5] 分支定界求解\n";
		cout << "------------------------------------------------------------\n";
		Values.branch_status = 1;
		BranchAndPriceTree(Values, Lists);
	} else {
		cout << "[阶段5] 无需分支定界 (已获得整数解)\n";
	}
	cout << "\n";

	// =========================================================================
	// 输出求解结果
	// =========================================================================
	cout << "============================================================\n";
	cout << "  求解结果\n";
	cout << "============================================================\n";

	auto end_time = chrono::high_resolution_clock::now();
	auto duration = chrono::duration_cast<chrono::milliseconds>(end_time - start_time);
	double seconds = duration.count() / 1000.0;

	cout << fixed << setprecision(2);
	cout << "  最优目标值: " << Values.optimal_LB << "\n";
	cout << "  总耗时: " << seconds << " 秒\n";
	cout << "  节点数: " << Values.node_num << "\n";
	cout.unsetf(ios::fixed);

	cout << "============================================================\n";
	cout << "\n";
	cout << "[完成] 程序执行结束\n";

	return 0;
}
